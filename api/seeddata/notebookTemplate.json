[{"model": "genie.notebooktemplate", "pk": 1, "fields": {"template": {"paragraphs": [{"text": "%spark.pyspark\n# ==========================================\n# Oracle connection properties\n# ==========================================\noracleDBHost = \"{{sourceConnection_host}}\"\noracleDBPort = \"{{sourceConnection_port}}\"\noracleDBSID = \"{{sourceConnection_sid}}\"\noracleDBUsername = \"{{sourceConnection_username}}\"\noracleDBPassword = \"{{sourceConnection_password}}\"\noracleDBQuery = \"\"\"{{sqlQuery}}\"\"\"\nprimaryColumnName = \"{{primaryKeyColumn}}\"\n# ==========================================\n\ndf = spark.read \\\n    .format(\"jdbc\") \\\n    .option(\"url\", f\"jdbc:oracle:thin:@{oracleDBHost}:{oracleDBPort}/{oracleDBSID}\") \\\n    .option(\"query\", oracleDBQuery) \\\n    .option(\"password\", oracleDBPassword) \\\n    .option(\"user\", oracleDBUsername) \\\n    .option(\"driver\", \"oracle.jdbc.driver.OracleDriver\") \\\n    .load()\n    \n# Set order by column for SortOrder\ndf = df.orderBy(\"{{primaryKeyColumn}}\")\n\n# Store results in temp table\ndf.createOrReplaceTempView(\"{{tempTableName}}\")", "user": "anonymous", "progress": 0, "config": {"tableHide": false, "editorSetting": {"language": "python", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/python", "fontSize": 9, "editorHide": false, "title": true, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "id": "paragraph_1616145245686_1473486751", "status": "READY", "title": "Read Source Database"}, {"text": "%spark.sql\n-- Create table if not exist\nCREATE TABLE IF NOT EXISTS lakehouse.cuelake.{{destinationTableName}} USING iceberg AS SELECT * from {{tempTableName}}", "user": "anonymous", "progress": 0, "config": {"editorSetting": {"language": "sql", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/sql", "fontSize": 9, "editorHide": false, "title": true, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "id": "paragraph_1615528549981_865522288", "status": "READY", "title": "Create Table If Not Exist"}, {"text": "%spark\nval tableName = \"{{destinationTableName}}\"\nimport org.apache.iceberg.aws.glue.GlueCatalog;\nimport scala.collection.JavaConverters.mapAsJavaMapConverter\nimport org.apache.iceberg.actions.Actions;\n\nval properties = Map(\"warehouse\"-> sc.getConf.get(\"spark.sql.catalog.lakehouse.warehouse\")).asJava\n\nval catalog = new GlueCatalog();\ncatalog.initialize(\"lakehouse\", properties)\n\n\nimport org.apache.iceberg.Table;\nimport org.apache.iceberg.catalog.TableIdentifier;\n\nval name = TableIdentifier.of(\"cuelake\", tableName);\nval table = catalog.loadTable(name);\n\n// Expire older snapshots and commit\ntable.expireSnapshots().commit()\n\n// Run Compaction for table\nActions.forTable(table).rewriteDataFiles()\n    .targetSizeInBytes(500 * 1024 * 1024 * 10) // 5000 MB\n    .execute();", "user": "anonymous", "progress": 0, "config": {"editorSetting": {"language": "scala", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/scala", "fontSize": 9, "title": true, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "id": "paragraph_1616655403846_1323321554", "status": "READY", "title": "Iceberg Table Optimizations"}, {"text": "%spark.pyspark\nmaxVal=spark.sql(f\"SELECT MAX({{timestampColumn}}) FROM lakehouse.cuelake.{{destinationTableName}}\").collect()[0][0]\nz.put(\"{{tempTableName}}_val\", maxVal)\nprint(\"Timestamp value in target table: \" + str(maxVal))", "user": "anonymous", "progress": 0, "config": {"editorSetting": {"language": "python", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/python", "fontSize": 9, "title": true, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "id": "paragraph_1615885036622_2137552499", "status": "READY", "title": "Get Timestamp From Destination Table"}, {"text": "%spark.sql\n-- SQL Query to configure sort order\nALTER TABLE lakehouse.cuelake.{{destinationTableName}} WRITE ORDERED BY {{primaryKeyColumn}};", "user": "anonymous", "progress": 0, "config": {"editorSetting": {"language": "sql", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/sql", "fontSize": 9, "title": true, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "id": "paragraph_1616144051503_913231705", "status": "READY", "title": "Update Iceberg Table Properties"}, {"text": "%spark.pyspark\nmergeSql = f\"MERGE INTO lakehouse.cuelake.{{destinationTableName}} t USING (SELECT * from {{tempTableName}} where {{timestampColumn}} > \\\"{z.get('{{tempTableName}}_val')}\\\") u ON t.{{primaryKeyColumn}} = u.{{primaryKeyColumn}} WHEN MATCHED THEN UPDATE SET * WHEN NOT MATCHED THEN INSERT *\"\nprint(\"Executing SQL: \" + mergeSql)\nspark.sql(mergeSql)", "user": "anonymous", "progress": 0, "config": {"editorSetting": {"language": "sql", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/sql", "fontSize": 9, "title": true, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "id": "paragraph_1616147422888_2080009648", "status": "READY", "title": "Merge New Data"}], "name": "{{name}}", "defaultInterpreterGroup": "spark", "version": "0.9.0", "noteParams": {}, "noteForms": {}, "angularObjects": {}, "config": {"isZeppelinNotebookCronEnable": false, "looknfeel": "default", "personalizedMode": "false"}, "info": {}}, "formJson": {"fields": [{"name": "sourceConnection", "label": "Source Connection", "rules": [{"required": true, "message": "Source Connection is required"}], "type": "connectionSelect", "filter": ["Oracle"]}, {"name": "sqlQuery", "label": "SQL Query", "rules": [{"required": true, "message": "SQL Query is required"}], "type": "sql"}, {"name": "timestampColumn", "label": "Timestamp Column", "rules": [{"required": true, "message": "Timestamp Column is required"}], "type": "text"}, {"name": "primaryKeyColumn", "label": "Primary Key Column", "rules": [{"required": true, "message": "Primary Key Column is required"}], "type": "text"}, {"name": "destinationTableName", "label": "Destination Table Name", "rules": [{"required": true, "message": "Destination Table Name is required"}], "type": "text"}]}, "name": "Incremental Refresh"}}, {"model": "genie.notebooktemplate", "pk": 2, "fields": {"template": {"name": "{{name}}", "version": "0.9.0", "paragraphs": [{"text": "%spark.pyspark\n# ==========================================\n# Oracle connection properties\n# ==========================================\noracleDBHost = \"{{sourceConnection_host}}\"\noracleDBPort = \"{{sourceConnection_port}}\"\noracleDBSID = \"{{sourceConnection_sid}}\"\noracleDBUsername = \"{{sourceConnection_username}}\"\noracleDBPassword = \"{{sourceConnection_password}}\"\noracleDBQuery = \"\"\"{{sqlQuery}}\"\"\"\nprimaryColumnName = \"{{primaryKeyColumn}}\"\n# ==========================================\n\ndf = spark.read \\\n    .format(\"jdbc\") \\\n    .option(\"url\", f\"jdbc:oracle:thin:@{oracleDBHost}:{oracleDBPort}/{oracleDBSID}\") \\\n    .option(\"query\", oracleDBQuery) \\\n    .option(\"password\", oracleDBPassword) \\\n    .option(\"user\", oracleDBUsername) \\\n    .option(\"driver\", \"oracle.jdbc.driver.OracleDriver\") \\\n    .load()\n\n# Store results in temp table\ndf.createOrReplaceTempView(\"{{tempTableName}}\")", "user": "anonymous", "dateUpdated": "2021-04-16T10:20:36+0000", "progress": 0, "config": {"tableHide": false, "editorSetting": {"language": "python", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/python", "fontSize": 9, "editorHide": false, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "jobName": "paragraph_1618564169758_666989975", "id": "paragraph_1616145245686_1473486751", "dateCreated": "2021-04-16T09:09:29+0000", "status": "READY", "title": "Read Source Database"}, {"text": "%spark.sql\nDROP TABLE IF EXISTS lakehouse.cuelake.{{destinationTableName}}; \nCREATE TABLE lakehouse.cuelake.{{destinationTableName}} USING iceberg AS SELECT * from {{tempTableName}}", "user": "anonymous", "dateUpdated": "2021-04-16T10:22:19+0000", "progress": 0, "config": {"editorSetting": {"language": "sql", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/sql", "fontSize": 9, "editorHide": false, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "jobName": "paragraph_1618564169763_1116172688", "id": "paragraph_1615528549981_865522288", "dateCreated": "2021-04-16T09:09:29+0000", "status": "READY", "title": "Refresh Destination Table"}], "defaultInterpreterGroup": "spark", "config": {"isZeppelinNotebookCronEnable": false, "looknfeel": "default", "personalizedMode": "false"}, "info": {"isRunning": false}, "noteParams": {}, "noteForms": {}, "angularObjects": {}}, "formJson": {"fields": [{"name": "sourceConnection", "label": "Source Connection", "rules": [{"required": true, "message": "Source Connection is required"}], "type": "connectionSelect", "filter": ["Oracle"]}, {"name": "sqlQuery", "label": "SQL Query", "rules": [{"required": true, "message": "SQL Query is required"}], "type": "sql"}, {"name": "destinationTableName", "label": "Destination Table Name", "rules": [{"required": true, "message": "Destination Table Name is required"}], "type": "text"}]}, "name": "Full Refresh"}}, {"model": "genie.notebooktemplate", "pk": 3, "fields": {"template": {"name": "{{name}}", "version": "0.9.0", "paragraphs": [{"text": "%spark.sql\nSELECT * FROM", "user": "anonymous", "config": {"editorSetting": {"language": "text", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/text", "fontSize": 9, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "status": "READY", "focus": true}], "defaultInterpreterGroup": "spark", "config": {"isZeppelinNotebookCronEnable": false, "looknfeel": "default", "personalizedMode": "false"}, "info": {"isRunning": false}, "noteParams": {}, "noteForms": {}, "angularObjects": {}}, "formJson": {"fields": []}, "name": "Blank"}}]
