[{"model": "genie.notebooktemplate", "pk": 1, "fields": {"template": {"paragraphs": [{"title": "Read Source Database", "text": "%spark.pyspark\n# ==========================================\n# Connection Properties\n# ==========================================\ndBHost = \"{{sourceConnection_host}}\"\ndBPort = \"{{sourceConnection_port}}\"\ndBSID = \"{{sourceConnection_sid}}\"\ndBName = \"{{sourceConnection_database}}\"\ndBUsername = \"{{sourceConnection_username}}\"\ndBPassword = \"{{sourceConnection_password}}\"\ndBQuery = \"\"\"{{sqlQuery}}\"\"\"\nprimaryColumnName = \"{{primaryKeyColumn}}\"\n# ==========================================\n\nif \"{{sourceConnection_type}}\"==\"Oracle\":\n    df = spark.read \\\n        .format(\"jdbc\") \\\n        .option(\"url\", f\"jdbc:oracle:thin:@{dBHost}:{dBPort}/{dBSID}\") \\\n        .option(\"query\", dBQuery) \\\n        .option(\"password\", dBPassword) \\\n        .option(\"user\", dBUsername) \\\n        .option(\"driver\", \"oracle.jdbc.driver.OracleDriver\") \\\n        .load()\n        \nelif \"{{sourceConnection_type}}\"==\"Postgres\":\n    df = spark.read \\\n        .format(\"jdbc\") \\\n        .option(\"url\", f\"jdbc:postgresql://{dBHost}:{dBPort}/{dBName}\") \\\n        .option(\"query\", dBQuery) \\\n        .option(\"password\", dBPassword) \\\n        .option(\"user\", dBUsername) \\\n        .option(\"driver\", \"org.postgresql.Driver\")\n    if \"{{sourceConnection_sslRequired}}\" == \"True\":\n        df = df.option(\"sslmode\", \"require\")\n    df = df.load()\n    \nelif \"{{sourceConnection_type}}\"==\"MySQL\":\n    df = spark.read \\\n        .format(\"jdbc\") \\\n        .option(\"url\", f\"jdbc:mysql://{dBHost}:{dBPort}/{dBName}\") \\\n        .option(\"query\", dBQuery) \\\n        .option(\"password\", dBPassword) \\\n        .option(\"user\", dBUsername)\n    if \"{{sourceConnection_sslRequired}}\" == \"True\":\n        df = df.option(\"sslmode\", \"require\")\n    df = df.load()\n        \n# Set order by column for SortOrder\ndf = df.orderBy(\"{{primaryKeyColumn}}\")\n\n# Store results in temp table\ndf.createOrReplaceTempView(\"{{tempTableName}}\")", "user": "anonymous", "dateUpdated": "2021-04-26T19:16:48+0000", "progress": 0, "config": {"tableHide": false, "editorSetting": {"language": "python", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/python", "fontSize": 9, "editorHide": false, "title": true, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "jobName": "paragraph_1619459617352_2047119125", "id": "paragraph_1616145245686_1473486751", "dateCreated": "2021-04-26T17:53:37+0000", "status": "READY", "focus": true, "$$hashKey": "object:928"}, {"title": "Create Table If Not Exist", "text": "%spark.sql\n-- Create table if not exist\nCREATE TABLE IF NOT EXISTS lakehouse.cuelake.{{destinationTableName}} USING iceberg AS SELECT * from {{tempTableName}}", "user": "anonymous", "dateUpdated": "2021-04-26T17:53:37+0000", "progress": 0, "config": {"editorSetting": {"language": "sql", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/sql", "fontSize": 9, "editorHide": false, "title": true, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "jobName": "paragraph_1619459617352_1902312980", "id": "paragraph_1615528549981_865522288", "dateCreated": "2021-04-26T17:53:37+0000", "status": "READY", "$$hashKey": "object:929"}, {"title": "Iceberg Table Optimizations", "text": "%spark\nval tableName = \"{{destinationTableName}}\"\nimport org.apache.iceberg.aws.glue.GlueCatalog;\nimport scala.collection.JavaConverters.mapAsJavaMapConverter\nimport org.apache.iceberg.actions.Actions;\n\nval properties = Map(\"warehouse\"-> sc.getConf.get(\"spark.sql.catalog.lakehouse.warehouse\")).asJava\n\nval catalog = new GlueCatalog();\ncatalog.initialize(\"lakehouse\", properties)\n\n\nimport org.apache.iceberg.Table;\nimport org.apache.iceberg.catalog.TableIdentifier;\n\nval name = TableIdentifier.of(\"cuelake\", tableName);\nval table = catalog.loadTable(name);\n\n// Expire older snapshots and commit\ntable.expireSnapshots().commit()\n\n// Run Compaction for table\nActions.forTable(table).rewriteDataFiles()\n    .targetSizeInBytes(500 * 1024 * 1024 * 10) // 5000 MB\n    .execute();", "user": "anonymous", "dateUpdated": "2021-04-26T17:53:37+0000", "progress": 0, "config": {"editorSetting": {"language": "scala", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/scala", "fontSize": 9, "title": true, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "jobName": "paragraph_1619459617352_1034740601", "id": "paragraph_1616655403846_1323321554", "dateCreated": "2021-04-26T17:53:37+0000", "status": "READY", "$$hashKey": "object:930"}, {"title": "Get Timestamp From Destination Table", "text": "%spark.pyspark\nmaxVal=spark.sql(f\"SELECT MAX({{timestampColumn}}) FROM lakehouse.cuelake.{{destinationTableName}}\").collect()[0][0]\nz.put(\"{{tempTableName}}_val\", maxVal)\nprint(\"Timestamp value in target table: \" + str(maxVal))", "user": "anonymous", "dateUpdated": "2021-04-26T17:53:37+0000", "progress": 0, "config": {"editorSetting": {"language": "python", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/python", "fontSize": 9, "title": true, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "jobName": "paragraph_1619459617352_975985851", "id": "paragraph_1615885036622_2137552499", "dateCreated": "2021-04-26T17:53:37+0000", "status": "READY", "$$hashKey": "object:931"}, {"title": "Update Iceberg Table Properties", "text": "%spark.sql\n-- SQL Query to configure sort order\nALTER TABLE lakehouse.cuelake.{{destinationTableName}} WRITE ORDERED BY {{primaryKeyColumn}};", "user": "anonymous", "dateUpdated": "2021-04-26T17:53:37+0000", "progress": 0, "config": {"editorSetting": {"language": "sql", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/sql", "fontSize": 9, "title": true, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "jobName": "paragraph_1619459617352_810841844", "id": "paragraph_1616144051503_913231705", "dateCreated": "2021-04-26T17:53:37+0000", "status": "READY", "$$hashKey": "object:932"}, {"title": "Merge New Data", "text": "%spark.pyspark\nmergeSql = f\"MERGE INTO lakehouse.cuelake.{{destinationTableName}} t USING (SELECT * from {{tempTableName}} where {{timestampColumn}} > \\\"{z.get('{{tempTableName}}_val')}\\\") u ON t.{{primaryKeyColumn}} = u.{{primaryKeyColumn}} WHEN MATCHED THEN UPDATE SET * WHEN NOT MATCHED THEN INSERT *\"\nprint(\"Executing SQL: \" + mergeSql)\nspark.sql(mergeSql)", "user": "anonymous", "dateUpdated": "2021-04-26T17:53:37+0000", "progress": 0, "config": {"editorSetting": {"language": "python", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/python", "fontSize": 9, "title": true, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "jobName": "paragraph_1619459617353_1235940290", "id": "paragraph_1616147422888_2080009648", "dateCreated": "2021-04-26T17:53:37+0000", "status": "READY", "$$hashKey": "object:933"}], "name": "{{name}}", "id": "2G6W56CTJ", "defaultInterpreterGroup": "spark", "version": "0.9.0", "noteParams": {}, "noteForms": {}, "angularObjects": {}, "config": {"isZeppelinNotebookCronEnable": false, "looknfeel": "default", "personalizedMode": "false"}, "info": {}, "path": "/{{name}}"}, "formJson": {"fields": [{"name": "sourceConnection", "label": "Source Connection", "rules": [{"required": true, "message": "Source Connection is required"}], "type": "connectionSelect", "filter": ["Oracle", "Postgres", "MySQL"]}, {"name": "sqlQuery", "label": "SQL Query", "rules": [{"required": true, "message": "SQL Query is required"}], "type": "sql"}, {"name": "timestampColumn", "label": "Timestamp Column", "rules": [{"required": true, "message": "Timestamp Column is required"}], "type": "text"}, {"name": "primaryKeyColumn", "label": "Primary Key Column", "rules": [{"required": true, "message": "Primary Key Column is required"}], "type": "text"}, {"name": "destinationTableName", "label": "Destination Table Name", "rules": [{"required": true, "message": "Destination Table Name is required"}], "type": "text"}]}, "name": "Incremental Refresh"}}, {"model": "genie.notebooktemplate", "pk": 2, "fields": {"template": {"paragraphs": [{"title": "Read Source Database", "text": "%spark.pyspark\n# ==========================================\n# Connection Properties\n# ==========================================\ndBHost = \"{{sourceConnection_host}}\"\ndBPort = \"{{sourceConnection_port}}\"\ndBSID = \"{{sourceConnection_sid}}\"\ndBName = \"{{sourceConnection_database}}\"\ndBUsername = \"{{sourceConnection_username}}\"\ndBPassword = \"{{sourceConnection_password}}\"\ndBQuery = \"\"\"{{sqlQuery}}\"\"\"\nprimaryColumnName = \"{{primaryKeyColumn}}\"\n# ==========================================\n\nif \"{{sourceConnection_type}}\"==\"Oracle\":\n    df = spark.read \\\n        .format(\"jdbc\") \\\n        .option(\"url\", f\"jdbc:oracle:thin:@{dBHost}:{dBPort}/{dBSID}\") \\\n        .option(\"query\", dBQuery) \\\n        .option(\"password\", dBPassword) \\\n        .option(\"user\", dBUsername) \\\n        .option(\"driver\", \"oracle.jdbc.driver.OracleDriver\") \\\n        .load()\n        \nelif \"{{sourceConnection_type}}\"==\"Postgres\":\n    df = spark.read \\\n        .format(\"jdbc\") \\\n        .option(\"url\", f\"jdbc:postgresql://{dBHost}:{dBPort}/{dBName}\") \\\n        .option(\"query\", dBQuery) \\\n        .option(\"password\", dBPassword) \\\n        .option(\"user\", dBUsername) \\\n        .option(\"driver\", \"org.postgresql.Driver\")\n    if \"{{sourceConnection_sslRequired}}\" == \"True\":\n        df = df.option(\"sslmode\", \"require\")\n    df = df.load()\n    \nelif \"{{sourceConnection_type}}\"==\"MySQL\":\n    df = spark.read \\\n        .format(\"jdbc\") \\\n        .option(\"url\", f\"jdbc:mysql://{dBHost}:{dBPort}/{dBName}\") \\\n        .option(\"query\", dBQuery) \\\n        .option(\"password\", dBPassword) \\\n        .option(\"user\", dBUsername)\n    if \"{{sourceConnection_sslRequired}}\" == \"True\":\n        df = df.option(\"sslmode\", \"require\")\n    df = df.load()\n\n# Store results in temp table\ndf.createOrReplaceTempView(\"{{tempTableName}}\")", "user": "anonymous", "dateUpdated": "2021-04-26T21:09:38+0000", "progress": 0, "config": {"tableHide": false, "editorSetting": {"language": "python", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/python", "fontSize": 9, "editorHide": false, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "jobName": "paragraph_1619471291607_747575162", "id": "paragraph_1616145245686_1473486751", "dateCreated": "2021-04-26T21:08:11+0000", "status": "READY", "focus": true, "$$hashKey": "object:1438"}, {"title": "Refresh Destination Table", "text": "%spark.sql\nDROP TABLE IF EXISTS lakehouse.cuelake.{{destinationTableName}}; \nCREATE TABLE lakehouse.cuelake.{{destinationTableName}} USING iceberg AS SELECT * from {{tempTableName}}", "user": "anonymous", "dateUpdated": "2021-04-26T21:08:11+0000", "progress": 0, "config": {"editorSetting": {"language": "sql", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/sql", "fontSize": 9, "editorHide": false, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "jobName": "paragraph_1619471291608_1787407030", "id": "paragraph_1615528549981_865522288", "dateCreated": "2021-04-26T21:08:11+0000", "status": "READY", "$$hashKey": "object:1439"}], "name": "{{name}}", "id": "2G494RJKR", "defaultInterpreterGroup": "spark", "version": "0.9.0", "noteParams": {}, "noteForms": {}, "angularObjects": {}, "config": {"isZeppelinNotebookCronEnable": false, "looknfeel": "default", "personalizedMode": "false"}, "info": {}, "path": "/{{name}}"}, "formJson": {"fields": [{"name": "sourceConnection", "label": "Source Connection", "rules": [{"required": true, "message": "Source Connection is required"}], "type": "connectionSelect", "filter": ["Oracle", "Postgres", "MySQL"]}, {"name": "sqlQuery", "label": "SQL Query", "rules": [{"required": true, "message": "SQL Query is required"}], "type": "sql"}, {"name": "destinationTableName", "label": "Destination Table Name", "rules": [{"required": true, "message": "Destination Table Name is required"}], "type": "text"}]}, "name": "Full Refresh"}}, {"model": "genie.notebooktemplate", "pk": 3, "fields": {"template": {"name": "{{name}}", "version": "0.9.0", "paragraphs": [{"text": "%spark.sql\nSELECT * FROM", "user": "anonymous", "config": {"editorSetting": {"language": "text", "editOnDblClick": false, "completionKey": "TAB", "completionSupport": true}, "colWidth": 12, "editorMode": "ace/mode/text", "fontSize": 9, "results": {}, "enabled": true}, "settings": {"params": {}, "forms": {}}, "apps": [], "runtimeInfos": {}, "progressUpdateIntervalMs": 500, "status": "READY", "focus": true}], "defaultInterpreterGroup": "spark", "config": {"isZeppelinNotebookCronEnable": false, "looknfeel": "default", "personalizedMode": "false"}, "info": {"isRunning": false}, "noteParams": {}, "noteForms": {}, "angularObjects": {}}, "formJson": {"fields": []}, "name": "Blank"}},{"model": "genie.notebooktemplate", "pk": 4, "fields": {"template": {"id": "2G75EWJJ8", "info": {}, "name": "{{name}}", "path": "/{{name}}", "config": {"isZeppelinNotebookCronEnable": false}, "version": "0.9.0", "noteForms": {}, "noteParams": {}, "paragraphs": [{"id": "paragraph_1620194627902_821169804", "apps": [], "text": "import requests\n\ndruidUrl = \"{{druidLocation}}\"\ningestionSpec = \"\"\"{{datasetLocation|safe}}\"\"\"\n\nrequests.post(druidUrl, data=ingestionSpec)", "user": "anonymous", "config": {"enabled": true, "results": {}, "colWidth": 12.0, "fontSize": 9.0, "editorMode": "ace/mode/python", "editorSetting": {"language": "python", "editOnDblClick": false, "completionSupport": true}}, "status": "FINISHED", "jobName": "paragraph_1620194627902_821169804", "results": {"msg": [], "code": "SUCCESS"}, "progress": 0, "settings": {"forms": {}, "params": {}}, "dateCreated": "May 5, 2021 6:03:47 AM", "dateStarted": "May 5, 2021 6:03:53 AM", "dateUpdated": "May 5, 2021 6:24:49 AM", "dateFinished": "May 5, 2021 6:04:48 AM", "runtimeInfos": {}, "progressUpdateIntervalMs": 500}], "angularObjects": {}, "defaultInterpreterGroup": "python"}, "formJson": {"fields": [{"name": "datasetLocation", "type": "datasetSelector", "label": "Dataset Location", "rules": [{"message": "Dataset schema needs to be verified", "required": true}]}, {"name": "druidLocation", "type": "text", "label": "Druid Ingestion URL", "rules": [{"message": "Druid URL is needed", "required": true}]}]}, "name": "Druid Ingestion"}}]